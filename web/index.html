<!DOCTYPE html>
<html lang="fr" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>nxt-opds Bibliothèque</title>
  <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            brand: { 600: '#2563eb', 700: '#1d4ed8', 800: '#1e40af' }
          }
        }
      }
    }
  </script>
  <style>
    [v-cloak] { display: none; }
    .book-cover {
      aspect-ratio: 2/3;
      width: 100%;
      display: block;
      position: relative;
      overflow: hidden;
    }
    .book-cover img {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .book-cover .cover-placeholder {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 0.75rem;
    }
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>
</head>
<body class="h-full bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100">
<div id="app" v-cloak class="min-h-full flex flex-col">

  <!-- Header -->
  <header class="bg-white dark:bg-gray-800 shadow-sm sticky top-0 z-30">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-14 flex items-center gap-4">

      <!-- Book page: back button + title -->
      <template v-if="currentView === 'book'">
        <button @click="navigateTo('/')"
          class="flex items-center gap-1.5 shrink-0 text-gray-500 hover:text-gray-900 dark:hover:text-gray-100 transition-colors">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
          </svg>
          <span class="text-sm font-medium hidden sm:inline">Bibliothèque</span>
        </button>
        <span v-if="currentBook" class="font-semibold text-base truncate flex-1 min-w-0 text-gray-900 dark:text-gray-100">
          {{ currentBook.title }}
        </span>
        <div class="flex-1 sm:hidden"></div>
      </template>

      <!-- Series page: back button + series name -->
      <template v-else-if="currentView === 'series'">
        <button @click="navigateTo('/')"
          class="flex items-center gap-1.5 shrink-0 text-gray-500 hover:text-gray-900 dark:hover:text-gray-100 transition-colors">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
          </svg>
          <span class="text-sm font-medium hidden sm:inline">Bibliothèque</span>
        </button>
        <span class="font-semibold text-base truncate flex-1 min-w-0 text-amber-600 dark:text-amber-400">
          {{ currentSeries }}
        </span>
        <div class="flex-1 sm:hidden"></div>
      </template>

      <!-- Grid page: logo + search -->
      <template v-else>
        <a href="#/" class="flex items-center gap-2 shrink-0">
          <svg class="w-7 h-7 text-brand-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
          </svg>
          <span class="font-semibold text-lg hidden sm:block">nxt-opds</span>
        </a>

        <!-- Search bar -->
        <div class="flex-1 max-w-xl">
          <div class="relative">
            <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400 pointer-events-none"
                 fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0"/>
            </svg>
            <input
              v-model="searchQuery"
              type="search"
              placeholder="Rechercher livres, auteurs…"
              @input="onSearchInput"
              class="w-full pl-9 pr-4 py-1.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-brand-600 focus:border-transparent text-sm"
            />
          </div>
        </div>
      </template>

      <!-- Actions (grid-only: OPDS, refresh, upload; always: dark mode, logout) -->
      <div class="flex items-center gap-2 shrink-0">
        <template v-if="currentView === 'grid'">
          <a href="/opds" target="_blank" title="Flux OPDS"
             class="p-2 rounded-lg text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path d="M5 3a1 1 0 000 2c5.523 0 10 4.477 10 10a1 1 0 102 0C17 8.373 11.627 3 5 3z"/>
              <path d="M4 9a1 1 0 012 0c0 3.314 2.686 6 6 6a1 1 0 110 2A8 8 0 014 9zM3 15a2 2 0 114 0 2 2 0 01-4 0z"/>
            </svg>
          </a>

          <button @click="doRefresh" :disabled="refreshing" title="Rafraîchir le catalogue"
            class="p-2 rounded-lg text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors disabled:opacity-50">
            <svg class="w-5 h-5" :class="refreshing ? 'animate-spin' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
          </button>

          <button @click="uploadDialog = true" title="Téléverser un livre"
            class="flex items-center gap-1.5 px-3 py-1.5 bg-brand-600 hover:bg-brand-700 text-white text-sm font-medium rounded-lg transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
            </svg>
            <span class="hidden sm:inline">Téléverser</span>
          </button>
        </template>

        <button @click="toggleDark" title="Basculer le mode sombre"
          class="p-2 rounded-lg text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
          <svg v-if="isDark" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
          </svg>
          <svg v-else class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
          </svg>
        </button>

        <!-- Logout (POST form so the server clears the session cookie) -->
        <form method="POST" action="/logout" class="inline">
          <button type="submit" title="Se déconnecter"
            class="p-2 rounded-lg text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
            </svg>
          </button>
        </form>
      </div>
    </div>
  </header>

  <!-- Main content -->
  <main class="flex-1 max-w-7xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-6">

    <!-- ===== GRID VIEW ===== -->
    <template v-if="currentView === 'grid'">

      <!-- Filter bar -->
      <div class="flex flex-wrap items-center gap-3 mb-4">
        <p class="text-sm text-gray-500 dark:text-gray-400">
          <span v-if="searchQuery">{{ total }} résultat{{ total !== 1 ? 's' : '' }} pour « <strong>{{ searchQuery }}</strong> »</span>
          <span v-else-if="unreadOnly">{{ total }} livre{{ total !== 1 ? 's' : '' }} non lu{{ total !== 1 ? 's' : '' }}</span>
          <span v-else>{{ total }} livre{{ total !== 1 ? 's' : '' }} dans la bibliothèque</span>
        </p>

        <!-- Unread filter toggle -->
        <button @click="toggleUnreadFilter"
          :class="unreadOnly
            ? 'bg-brand-600 text-white border-brand-600'
            : 'border-gray-300 dark:border-gray-600 text-gray-600 dark:text-gray-300 hover:border-brand-600 hover:text-brand-600'"
          class="flex items-center gap-1.5 px-3 py-1 text-xs font-medium rounded-full border transition-colors">
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/>
          </svg>
          Non lus seulement
        </button>

        <!-- Sort selector -->
        <div class="ml-auto flex items-center gap-1.5">
          <svg class="w-3.5 h-3.5 text-gray-400 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h13M3 8h9M3 12h5m10 4l-4-4 4-4"/>
          </svg>
          <select v-model="sortOrder" @change="onSortChange"
            class="text-xs border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-600 dark:text-gray-300 rounded-lg px-2 py-1 focus:outline-none focus:ring-2 focus:ring-brand-600 cursor-pointer">
            <option value="added_desc">Ajout récent</option>
            <option value="added_asc">Ajout ancien</option>
            <option value="title_asc">Titre A→Z</option>
            <option value="title_desc">Titre Z→A</option>
          </select>
        </div>
      </div>

      <!-- Loading spinner -->
      <div v-if="loading" class="flex justify-center items-center py-24">
        <svg class="w-10 h-10 text-brand-600 animate-spin" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"/>
        </svg>
      </div>

      <!-- Empty state -->
      <div v-else-if="books.length === 0" class="flex flex-col items-center justify-center py-24 text-center">
        <svg class="w-20 h-20 text-gray-300 dark:text-gray-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
            d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
        </svg>
        <p class="text-lg font-medium text-gray-500 dark:text-gray-400">
          <span v-if="searchQuery">Aucun livre ne correspond à votre recherche</span>
          <span v-else-if="unreadOnly">Tous vos livres ont été lus !</span>
          <span v-else>Votre bibliothèque est vide</span>
        </p>
        <p class="text-sm text-gray-400 dark:text-gray-500 mt-1">
          <span v-if="searchQuery">Essayez un autre terme de recherche</span>
          <span v-else-if="unreadOnly">Retirez le filtre pour voir tous les livres</span>
          <span v-else>Téléversez un EPUB ou PDF pour commencer</span>
        </p>
        <button v-if="unreadOnly" @click="toggleUnreadFilter"
          class="mt-4 px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 text-sm font-medium rounded-lg transition-colors">
          Voir tous les livres
        </button>
        <button v-else-if="!searchQuery" @click="uploadDialog = true"
          class="mt-4 px-4 py-2 bg-brand-600 hover:bg-brand-700 text-white text-sm font-medium rounded-lg transition-colors">
          Téléverser votre premier livre
        </button>
      </div>

      <!-- Book grid -->
      <div v-else class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 sm:gap-6">
        <div
          v-for="book in books"
          :key="book.id"
          @click="navigateTo('/books/' + book.id)"
          class="group cursor-pointer"
        >
          <!-- Cover -->
          <div class="shadow-md hover:shadow-xl transition-shadow duration-200 bg-gray-200 dark:bg-gray-700 book-cover"
               :class="book.isRead ? 'rounded-t-lg mb-0' : 'rounded-lg mb-2'">
            <img
              v-if="book.coverUrl"
              :src="book.coverUrl"
              :alt="book.title"
              class="group-hover:scale-105 transition-transform duration-200"
              loading="lazy"
              @error="book.coverUrl = ''"
            />
            <div v-else class="cover-placeholder"
                 :style="{ background: coverGradient(book.id) }">
              <svg class="w-10 h-10 text-white/60 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                  d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
              </svg>
              <span class="text-white/80 text-xs text-center leading-tight line-clamp-2 font-medium">{{ book.title }}</span>
            </div>
          </div>
          <!-- Read banner (below cover) -->
          <div v-if="book.isRead"
               class="rounded-b-lg bg-gradient-to-r from-green-600 to-emerald-500 py-1.5 px-2 flex items-center justify-center gap-1.5 mb-2">
            <svg class="w-3.5 h-3.5 text-white shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
            </svg>
            <span class="text-white text-xs font-bold leading-none">Lu</span>
          </div>

          <!-- Meta -->
          <div class="px-0.5">
            <p class="text-sm font-medium text-gray-900 dark:text-gray-100 line-clamp-2 leading-snug" :title="book.title">
              {{ book.title }}
            </p>
            <p v-if="book.series" class="text-xs text-amber-600 dark:text-amber-400 mt-0.5 truncate font-medium">
              <a @click.stop="navigateTo('/series/' + encodeURIComponent(book.series))"
                 class="hover:underline cursor-pointer">{{ book.series }}</a><span v-if="book.seriesIndex"> #{{ book.seriesIndex }}<span v-if="book.seriesTotal">/{{ book.seriesTotal }}</span></span>
            </p>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5 truncate" :title="(book.authors || []).join(', ')">
              {{ (book.authors || []).join(', ') || 'Auteur inconnu' }}
            </p>
            <div v-if="book.rating > 0" class="flex gap-0.5 mt-1">
              <svg v-for="s in 5" :key="s" class="w-3 h-3" :class="s <= book.rating ? 'text-amber-400' : 'text-gray-200 dark:text-gray-700'"
                   fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
              </svg>
            </div>
          </div>
        </div>
      </div>

      <!-- Pagination -->
      <div v-if="totalPages > 1" class="mt-8 flex justify-center items-center gap-1">
        <button @click="goPage(page - 1)" :disabled="page <= 1"
          class="px-3 py-1.5 text-sm rounded-lg border border-gray-300 dark:border-gray-600 disabled:opacity-40 disabled:cursor-not-allowed hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
          &laquo;
        </button>
        <template v-for="p in pageNumbers" :key="p">
          <span v-if="p === '…'" class="px-2 py-1.5 text-sm text-gray-400">…</span>
          <button v-else @click="goPage(p)"
            :class="p === page
              ? 'bg-brand-600 text-white border-brand-600'
              : 'border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700'"
            class="px-3 py-1.5 text-sm rounded-lg border transition-colors">
            {{ p }}
          </button>
        </template>
        <button @click="goPage(page + 1)" :disabled="page >= totalPages"
          class="px-3 py-1.5 text-sm rounded-lg border border-gray-300 dark:border-gray-600 disabled:opacity-40 disabled:cursor-not-allowed hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
          &raquo;
        </button>
      </div>

    </template><!-- end grid view -->

    <!-- ===== BOOK DETAIL PAGE ===== -->
    <template v-else-if="currentView === 'book'">

      <!-- Loading state -->
      <div v-if="bookLoading" class="flex justify-center items-center py-24">
        <svg class="w-10 h-10 text-brand-600 animate-spin" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"/>
        </svg>
      </div>

      <!-- Book not found -->
      <div v-else-if="!currentBook" class="flex flex-col items-center justify-center py-24 text-center">
        <p class="text-lg font-medium text-gray-500 dark:text-gray-400">Livre introuvable</p>
        <button @click="navigateTo('/')" class="mt-4 px-4 py-2 bg-brand-600 hover:bg-brand-700 text-white text-sm font-medium rounded-lg transition-colors">
          Retour à la bibliothèque
        </button>
      </div>

      <!-- Book detail content -->
      <div v-else class="flex flex-col sm:flex-row gap-8 lg:gap-12">

        <!-- Left column: cover + download -->
        <div class="shrink-0 flex flex-col items-center sm:items-start sm:w-52 lg:w-60">
          <div class="w-48 sm:w-full book-cover rounded-xl overflow-hidden shadow-xl bg-gray-200 dark:bg-gray-700">
            <img v-if="currentBook.coverUrl" :src="currentBook.coverUrl" :alt="currentBook.title"
                 class="w-full h-full object-cover"
                 @error="currentBook.coverUrl = ''" />
            <div v-else class="w-full h-full flex flex-col items-center justify-center p-6"
                 :style="{ background: coverGradient(currentBook.id) }">
              <svg class="w-16 h-16 text-white/50 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                  d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
              </svg>
              <span class="text-white/80 text-sm text-center font-medium leading-snug">{{ currentBook.title }}</span>
            </div>
          </div>

          <!-- Download button -->
          <a :href="currentBook.downloadUrl"
            class="mt-4 w-48 sm:w-full flex items-center justify-center gap-2 px-4 py-2.5 bg-brand-600 hover:bg-brand-700 text-white font-medium rounded-xl transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
            </svg>
            Télécharger
          </a>

          <!-- Change cover button + hidden file input -->
          <input type="file" accept="image/*" class="hidden" ref="coverFileInput"
                 @change="onCoverFileChange(currentBook, $event)" />
          <button @click="$refs.coverFileInput.click()" :disabled="coverUploading"
            class="mt-2 w-48 sm:w-full flex items-center justify-center gap-2 px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700 text-sm font-medium rounded-xl transition-colors disabled:opacity-50">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
            {{ coverUploading ? 'Envoi…' : 'Changer la couverture' }}
          </button>
        </div>

        <!-- Right column: metadata -->
        <div class="flex-1 min-w-0">

          <!-- Title -->
          <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 dark:text-gray-100 leading-tight mb-1">
            {{ currentBook.title }}
          </h1>

          <!-- Series (between title and authors) -->
          <p v-if="currentBook.series"
             class="text-base font-medium text-amber-600 dark:text-amber-400 mb-1">
            <a @click="navigateTo('/series/' + encodeURIComponent(currentBook.series))"
               class="hover:underline cursor-pointer">{{ currentBook.series }}</a><span v-if="currentBook.seriesIndex"> — #{{ currentBook.seriesIndex }}<span v-if="currentBook.seriesTotal">/{{ currentBook.seriesTotal }}</span></span>
          </p>

          <!-- Authors -->
          <p v-if="currentBook.authors && currentBook.authors.length"
             class="text-lg text-gray-600 dark:text-gray-400 mb-4">
            {{ currentBook.authors.join(', ') }}
          </p>

          <!-- Read badge -->
          <div v-if="currentBook.isRead"
               class="inline-flex items-center gap-1.5 px-3 py-1 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 rounded-full text-sm font-medium mb-4">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
            Lu
          </div>

          <!-- Metadata table -->
          <dl v-if="currentBook.publisher || currentBook.language" class="flex flex-wrap gap-x-8 gap-y-1 text-sm mb-4">
            <template v-if="currentBook.publisher">
              <div class="flex gap-2">
                <dt class="text-gray-500 dark:text-gray-400">Éditeur</dt>
                <dd class="text-gray-900 dark:text-gray-100 font-medium">{{ currentBook.publisher }}</dd>
              </div>
            </template>
            <template v-if="currentBook.language">
              <div class="flex gap-2">
                <dt class="text-gray-500 dark:text-gray-400">Langue</dt>
                <dd class="text-gray-900 dark:text-gray-100 font-medium">{{ currentBook.language }}</dd>
              </div>
            </template>
          </dl>

          <!-- Tags -->
          <div v-if="currentBook.tags && currentBook.tags.length" class="flex flex-wrap gap-2 mb-6">
            <span v-for="tag in currentBook.tags" :key="tag"
              class="px-3 py-1 bg-blue-100 dark:bg-blue-900/40 text-blue-700 dark:text-blue-300 text-sm rounded-full">
              {{ tag }}
            </span>
          </div>

          <!-- Summary -->
          <div v-if="currentBook.summary" class="mb-6">
            <h2 class="text-xs font-semibold text-gray-400 dark:text-gray-500 uppercase tracking-wider mb-2">Description</h2>
            <p class="text-gray-700 dark:text-gray-300 leading-relaxed whitespace-pre-line">{{ currentBook.summary }}</p>
          </div>

          <!-- Star rating -->
          <div class="flex items-center gap-1 mb-4">
            <button v-for="star in 5" :key="star"
              @click="setRating(currentBook, star)"
              :title="star + ' étoile' + (star > 1 ? 's' : '')"
              class="p-0.5 transition-transform hover:scale-110 focus:outline-none">
              <svg class="w-7 h-7 transition-colors" :class="star <= currentBook.rating ? 'text-amber-400' : 'text-gray-300 dark:text-gray-600 hover:text-amber-300'"
                   fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
              </svg>
            </button>
            <button v-if="currentBook.rating > 0" @click="setRating(currentBook, 0)"
              class="ml-1 text-xs text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
              Effacer
            </button>
          </div>

          <!-- Action buttons -->
          <div class="flex flex-wrap gap-3 pt-2 border-t border-gray-200 dark:border-gray-700">

            <!-- Toggle read button -->
            <button @click="toggleRead(currentBook)" :disabled="togglingRead"
              :class="currentBook.isRead
                ? 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 border-green-300 dark:border-green-700 hover:bg-green-200 dark:hover:bg-green-900/50'
                : 'border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700'"
              class="flex items-center gap-2 px-4 py-2 border text-sm font-medium rounded-lg transition-colors disabled:opacity-50">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
              </svg>
              {{ currentBook.isRead ? 'Marquer comme non lu' : 'Marquer comme lu' }}
            </button>

            <button @click="openEdit(currentBook)"
              class="flex items-center gap-2 px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 text-sm font-medium rounded-lg transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
              </svg>
              Modifier les métadonnées
            </button>

            <!-- Delete button -->
            <button @click="deleteBook(currentBook)" :disabled="deleting"
              class="flex items-center gap-2 px-4 py-2 border border-red-300 dark:border-red-700 text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 text-sm font-medium rounded-lg transition-colors disabled:opacity-50 ml-auto">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
              </svg>
              {{ deleting ? 'Suppression…' : 'Supprimer' }}
            </button>
          </div>

        </div><!-- end right column -->
      </div><!-- end book detail -->

    </template><!-- end book view -->

    <!-- ===== SERIES PAGE ===== -->
    <template v-else-if="currentView === 'series'">

      <!-- Loading -->
      <div v-if="seriesLoading" class="flex justify-center items-center py-24">
        <svg class="w-10 h-10 text-brand-600 animate-spin" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"/>
        </svg>
      </div>

      <!-- Empty state -->
      <div v-else-if="seriesBooks.length === 0" class="flex flex-col items-center justify-center py-24 text-center">
        <p class="text-lg font-medium text-gray-500 dark:text-gray-400">Aucun livre dans cette série</p>
        <button @click="navigateTo('/')" class="mt-4 px-4 py-2 bg-brand-600 hover:bg-brand-700 text-white text-sm font-medium rounded-lg transition-colors">
          Retour à la bibliothèque
        </button>
      </div>

      <!-- Books grid sorted by series index -->
      <div v-else>
        <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">
          {{ seriesBooks.length }} tome{{ seriesBooks.length !== 1 ? 's' : '' }}
        </p>
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 sm:gap-6">
          <div
            v-for="book in seriesBooks"
            :key="book.id"
            @click="navigateTo('/books/' + book.id)"
            class="group cursor-pointer"
          >
            <!-- Cover -->
            <div class="shadow-md hover:shadow-xl transition-shadow duration-200 bg-gray-200 dark:bg-gray-700 book-cover"
                 :class="book.isRead ? 'rounded-t-lg mb-0' : 'rounded-lg mb-2'">
              <img v-if="book.coverUrl" :src="book.coverUrl" :alt="book.title"
                   class="group-hover:scale-105 transition-transform duration-200"
                   loading="lazy" @error="book.coverUrl = ''" />
              <div v-else class="cover-placeholder" :style="{ background: coverGradient(book.id) }">
                <svg class="w-10 h-10 text-white/60 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                    d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                </svg>
                <span class="text-white/80 text-xs text-center leading-tight line-clamp-2 font-medium">{{ book.title }}</span>
              </div>
            </div>
            <!-- Read banner -->
            <div v-if="book.isRead"
                 class="rounded-b-lg bg-gradient-to-r from-green-600 to-emerald-500 py-1.5 px-2 flex items-center justify-center gap-1.5 mb-2">
              <svg class="w-3.5 h-3.5 text-white shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
              </svg>
              <span class="text-white text-xs font-bold leading-none">Lu</span>
            </div>
            <!-- Meta -->
            <div class="px-0.5">
              <!-- Series index badge -->
              <p v-if="book.seriesIndex" class="text-xs font-bold text-amber-600 dark:text-amber-400 mb-0.5">
                Tome {{ book.seriesIndex }}<span v-if="book.seriesTotal"> / {{ book.seriesTotal }}</span>
              </p>
              <p class="text-sm font-medium text-gray-900 dark:text-gray-100 line-clamp-2 leading-snug">{{ book.title }}</p>
              <p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5 truncate">
                {{ (book.authors || []).join(', ') || 'Auteur inconnu' }}
              </p>
              <div v-if="book.rating > 0" class="flex gap-0.5 mt-1">
                <svg v-for="s in 5" :key="s" class="w-3 h-3" :class="s <= book.rating ? 'text-amber-400' : 'text-gray-200 dark:text-gray-700'"
                     fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                </svg>
              </div>
            </div>
          </div>
        </div>
      </div>

    </template><!-- end series view -->

  </main>

  <!-- ===== Upload Modal ===== -->
  <div v-if="uploadDialog" class="fixed inset-0 z-50 flex items-center justify-center p-4" @click.self="closeUpload">
    <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" @click="closeUpload"></div>
    <div class="relative bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-md w-full p-6 z-10">
      <button @click="closeUpload"
        class="absolute top-3 right-3 p-1.5 rounded-full bg-black/10 hover:bg-black/20 dark:bg-white/10 dark:hover:bg-white/20 transition-colors">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>

      <h2 class="text-lg font-bold text-gray-900 dark:text-gray-100 mb-4">Téléverser un livre</h2>

      <!-- Drop zone -->
      <div
        class="border-2 border-dashed rounded-xl p-8 text-center cursor-pointer transition-colors"
        :class="dragging
          ? 'border-brand-600 bg-blue-50 dark:bg-blue-900/20'
          : 'border-gray-300 dark:border-gray-600 hover:border-brand-600 hover:bg-gray-50 dark:hover:bg-gray-700/50'"
        @dragover.prevent="dragging = true"
        @dragleave="dragging = false"
        @drop.prevent="onDrop"
        @click="$refs.fileInput.click()"
      >
        <svg class="w-12 h-12 mx-auto text-gray-400 dark:text-gray-500 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
        </svg>
        <p class="text-sm text-gray-600 dark:text-gray-300">
          Déposez un EPUB ou PDF ici, ou <span class="text-brand-600 font-medium">parcourir</span>
        </p>
        <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">EPUB, PDF · max 100 Mo</p>
        <input ref="fileInput" type="file" accept=".epub,.pdf" class="hidden" @change="onFileSelect" />
      </div>

      <!-- Selected file -->
      <div v-if="uploadFile" class="mt-3 flex items-center gap-2 px-3 py-2 bg-blue-50 dark:bg-blue-900/20 rounded-lg text-sm">
        <svg class="w-4 h-4 text-brand-600 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
        </svg>
        <span class="flex-1 truncate font-medium text-gray-700 dark:text-gray-200">{{ uploadFile.name }}</span>
        <span class="text-gray-400 shrink-0">{{ formatBytes(uploadFile.size) }}</span>
      </div>

      <!-- Progress bar -->
      <div v-if="uploading" class="mt-3">
        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-1.5 overflow-hidden">
          <div class="bg-brand-600 h-1.5 rounded-full animate-pulse w-3/4"></div>
        </div>
        <p class="text-xs text-gray-400 mt-1 text-center">Téléversement en cours…</p>
      </div>

      <!-- Errors / success -->
      <div v-if="uploadError" class="mt-3 flex items-start gap-2 px-3 py-2 bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-300 rounded-lg text-sm">
        <svg class="w-4 h-4 shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        {{ uploadError }}
      </div>
      <div v-if="uploadSuccess" class="mt-3 flex items-start gap-2 px-3 py-2 bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-300 rounded-lg text-sm">
        <svg class="w-4 h-4 shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        « {{ uploadSuccess }} » ajouté à votre bibliothèque !
      </div>

      <!-- Actions -->
      <div class="mt-5 flex justify-end gap-3">
        <button @click="closeUpload"
          class="px-4 py-2 text-sm text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white transition-colors">
          Annuler
        </button>
        <button @click="doUpload" :disabled="!uploadFile || uploading"
          class="px-4 py-2 bg-brand-600 hover:bg-brand-700 disabled:opacity-50 disabled:cursor-not-allowed text-white text-sm font-medium rounded-lg transition-colors">
          {{ uploading ? 'Téléversement…' : 'Téléverser' }}
        </button>
      </div>
    </div>
  </div>

  <!-- ===== Edit Metadata Modal ===== -->
  <div v-if="editDialog" class="fixed inset-0 z-50 flex items-center justify-center p-4" @click.self="closeEdit">
    <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" @click="closeEdit"></div>
    <div class="relative bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-lg w-full p-6 z-10 overflow-y-auto max-h-[90vh]">
      <button @click="closeEdit"
        class="absolute top-3 right-3 p-1.5 rounded-full bg-black/10 hover:bg-black/20 dark:bg-white/10 dark:hover:bg-white/20 transition-colors">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>

      <h2 class="text-lg font-bold text-gray-900 dark:text-gray-100 mb-5">Modifier les métadonnées</h2>

      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Titre</label>
          <input v-model="editForm.title" type="text"
            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-sm focus:outline-none focus:ring-2 focus:ring-brand-600"/>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Auteurs <span class="font-normal text-gray-400">(séparés par des virgules)</span></label>
          <input v-model="editForm.authorsStr" type="text"
            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-sm focus:outline-none focus:ring-2 focus:ring-brand-600"/>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Étiquettes <span class="font-normal text-gray-400">(séparées par des virgules)</span></label>
          <input v-model="editForm.tagsStr" type="text"
            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-sm focus:outline-none focus:ring-2 focus:ring-brand-600"/>
        </div>

        <div class="flex gap-3">
          <div class="flex-1">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Série</label>
            <input v-model="editForm.series" type="text" placeholder="Nom de la série"
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-sm focus:outline-none focus:ring-2 focus:ring-brand-600"/>
          </div>
          <div class="w-20">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">N°</label>
            <input v-model="editForm.seriesIndex" type="text" placeholder="1"
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-sm focus:outline-none focus:ring-2 focus:ring-brand-600"/>
          </div>
          <div class="w-20">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Total</label>
            <input v-model="editForm.seriesTotal" type="text" placeholder="5"
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-sm focus:outline-none focus:ring-2 focus:ring-brand-600"/>
          </div>
        </div>

        <div class="flex gap-3">
          <div class="flex-1">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Éditeur</label>
            <input v-model="editForm.publisher" type="text"
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-sm focus:outline-none focus:ring-2 focus:ring-brand-600"/>
          </div>
          <div class="w-28">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Langue</label>
            <input v-model="editForm.language" type="text" placeholder="fr"
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-sm focus:outline-none focus:ring-2 focus:ring-brand-600"/>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Résumé</label>
          <textarea v-model="editForm.summary" rows="3"
            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-sm focus:outline-none focus:ring-2 focus:ring-brand-600 resize-none"></textarea>
        </div>
      </div>

      <div v-if="editError" class="mt-4 px-3 py-2 bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-300 rounded-lg text-sm">
        {{ editError }}
      </div>

      <div class="mt-6 flex justify-end gap-3">
        <button @click="closeEdit"
          class="px-4 py-2 text-sm text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white transition-colors">
          Annuler
        </button>
        <button @click="saveEdits" :disabled="editSaving"
          class="px-4 py-2 bg-brand-600 hover:bg-brand-700 disabled:opacity-50 disabled:cursor-not-allowed text-white text-sm font-medium rounded-lg transition-colors">
          {{ editSaving ? 'Enregistrement…' : 'Enregistrer' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div v-if="toast.show"
    class="fixed bottom-4 right-4 z-50 flex items-center gap-2 px-4 py-3 rounded-xl shadow-lg text-sm font-medium transition-all"
    :class="toast.type === 'error' ? 'bg-red-600 text-white' : 'bg-green-600 text-white'">
    {{ toast.message }}
  </div>

</div>

<script>
const { createApp, ref, computed, onMounted } = Vue

createApp({
  setup() {
    // ---- Dark mode ----
    const isDark = ref(localStorage.getItem('nxt-dark') === '1')
    function applyDark(v) {
      document.documentElement.classList.toggle('dark', v)
    }
    applyDark(isDark.value)
    function toggleDark() {
      isDark.value = !isDark.value
      localStorage.setItem('nxt-dark', isDark.value ? '1' : '0')
      applyDark(isDark.value)
    }

    // ---- Books state ----
    const books       = ref([])
    const total       = ref(0)
    const loading     = ref(false)
    const page        = ref(1)
    const PAGE_SIZE   = 48
    const searchQuery = ref('')
    const unreadOnly  = ref(false)
    const sortOrder   = ref(localStorage.getItem('nxt-sort') || 'added_desc')
    let searchTimer = null

    const totalPages = computed(() => Math.ceil(total.value / PAGE_SIZE))

    // Page numbers with ellipsis
    const pageNumbers = computed(() => {
      const t = totalPages.value
      const c = page.value
      if (t <= 7) return Array.from({ length: t }, (_, i) => i + 1)
      const pages = new Set([1, t, c])
      if (c > 2) pages.add(c - 1)
      if (c < t - 1) pages.add(c + 1)
      const sorted = [...pages].sort((a, b) => a - b)
      const result = []
      for (let i = 0; i < sorted.length; i++) {
        if (i > 0 && sorted[i] - sorted[i - 1] > 1) result.push('…')
        result.push(sorted[i])
      }
      return result
    })

    async function loadBooks() {
      loading.value = true
      try {
        const params = new URLSearchParams({
          limit:  PAGE_SIZE,
          offset: (page.value - 1) * PAGE_SIZE,
        })
        if (searchQuery.value.trim()) params.set('q', searchQuery.value.trim())
        if (unreadOnly.value) params.set('unread', '1')
        if (sortOrder.value) params.set('sort', sortOrder.value)
        const res = await fetch('/api/books?' + params)
        if (!res.ok) throw new Error('HTTP ' + res.status)
        const data = await res.json()
        books.value = data.books || []
        total.value = data.total  || 0
      } catch (e) {
        showToast('Échec du chargement des livres : ' + e.message, 'error')
      } finally {
        loading.value = false
      }
    }

    function onSearchInput() {
      clearTimeout(searchTimer)
      searchTimer = setTimeout(() => { page.value = 1; loadBooks() }, 350)
    }

    function toggleUnreadFilter() {
      unreadOnly.value = !unreadOnly.value
      page.value = 1
      loadBooks()
    }

    function onSortChange() {
      localStorage.setItem('nxt-sort', sortOrder.value)
      page.value = 1
      loadBooks()
    }

    function goPage(p) {
      if (p < 1 || p > totalPages.value) return
      page.value = p
      loadBooks()
      window.scrollTo({ top: 0, behavior: 'smooth' })
    }

    // ---- Cover gradient ----
    const GRADIENTS = [
      'linear-gradient(135deg,#667eea,#764ba2)',
      'linear-gradient(135deg,#f093fb,#f5576c)',
      'linear-gradient(135deg,#4facfe,#00f2fe)',
      'linear-gradient(135deg,#43e97b,#38f9d7)',
      'linear-gradient(135deg,#fa709a,#fee140)',
      'linear-gradient(135deg,#a18cd1,#fbc2eb)',
      'linear-gradient(135deg,#ffecd2,#fcb69f)',
      'linear-gradient(135deg,#a1c4fd,#c2e9fb)',
    ]
    function coverGradient(id) {
      let h = 0
      for (let i = 0; i < (id || '').length; i++) h = (h * 31 + id.charCodeAt(i)) & 0xffff
      return GRADIENTS[h % GRADIENTS.length]
    }

    // ---- Hash-based routing ----
    const currentView = ref('grid')  // 'grid' | 'book' | 'series'
    const currentBook = ref(null)
    const bookLoading = ref(false)
    const currentSeries = ref('')
    const seriesBooks = ref([])
    const seriesLoading = ref(false)

    function navigateTo(path) {
      window.location.hash = '#' + path
    }

    async function loadBook(id) {
      bookLoading.value = true
      currentBook.value = null
      try {
        const res = await fetch('/api/books/' + encodeURIComponent(id))
        if (!res.ok) throw new Error('HTTP ' + res.status)
        currentBook.value = await res.json()
      } catch (e) {
        showToast('Livre introuvable', 'error')
        navigateTo('/')
      } finally {
        bookLoading.value = false
      }
    }

    async function loadSeries(name) {
      seriesLoading.value = true
      seriesBooks.value = []
      try {
        const params = new URLSearchParams({ series: name, sort: 'series_index', limit: 500 })
        const res = await fetch('/api/books?' + params)
        if (!res.ok) throw new Error('HTTP ' + res.status)
        const data = await res.json()
        seriesBooks.value = data.books || []
      } catch (e) {
        showToast('Erreur : ' + e.message, 'error')
      } finally {
        seriesLoading.value = false
      }
    }

    async function onHashChange() {
      const hash = window.location.hash
      const bookMatch = hash.match(/^#\/books\/(.+)$/)
      const seriesMatch = hash.match(/^#\/series\/(.+)$/)
      if (bookMatch) {
        currentView.value = 'book'
        window.scrollTo({ top: 0, behavior: 'instant' })
        await loadBook(decodeURIComponent(bookMatch[1]))
      } else if (seriesMatch) {
        currentView.value = 'series'
        currentSeries.value = decodeURIComponent(seriesMatch[1])
        window.scrollTo({ top: 0, behavior: 'instant' })
        await loadSeries(currentSeries.value)
      } else {
        currentView.value = 'grid'
        currentBook.value = null
        await loadBooks()
        window.scrollTo({ top: 0, behavior: 'instant' })
      }
    }

    // ---- Toggle read ----
    const togglingRead = ref(false)

    async function toggleRead(book) {
      if (!book) return
      togglingRead.value = true
      try {
        const newIsRead = !book.isRead
        const res = await fetch('/api/books/' + book.id, {
          method:  'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body:    JSON.stringify({ isRead: newIsRead }),
        })
        if (!res.ok) throw new Error(await res.text() || 'Échec')
        const updated = await res.json()
        // Update current book page
        if (currentBook.value && currentBook.value.id === updated.id) {
          currentBook.value = updated
        }
        // Update books grid list in place
        const idx = books.value.findIndex(b => b.id === updated.id)
        if (idx !== -1) books.value[idx] = updated
        showToast(newIsRead ? 'Marqué comme lu' : 'Marqué comme non lu', 'success')
      } catch (e) {
        showToast('Erreur : ' + e.message, 'error')
      } finally {
        togglingRead.value = false
      }
    }

    // ---- Star rating ----
    async function setRating(book, stars) {
      if (!book) return
      // Clicking the same star as current rating clears it (toggle to 0)
      const newRating = book.rating === stars ? 0 : stars
      try {
        const res = await fetch('/api/books/' + book.id, {
          method:  'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body:    JSON.stringify({ rating: newRating }),
        })
        if (!res.ok) throw new Error(await res.text() || 'Échec')
        const updated = await res.json()
        if (currentBook.value && currentBook.value.id === updated.id) {
          currentBook.value = updated
        }
        const idx = books.value.findIndex(b => b.id === updated.id)
        if (idx !== -1) books.value[idx] = updated
      } catch (e) {
        showToast('Erreur : ' + e.message, 'error')
      }
    }

    // ---- Edit dialog ----
    const editDialog  = ref(false)
    const editBook    = ref(null)
    const editSaving  = ref(false)
    const editError   = ref('')
    const editForm    = ref({
      title: '', authorsStr: '', tagsStr: '', summary: '',
      publisher: '', language: '', series: '', seriesIndex: '', seriesTotal: '',
    })

    function openEdit(book) {
      editBook.value = book
      editForm.value = {
        title:       book.title || '',
        authorsStr:  (book.authors || []).join(', '),
        tagsStr:     (book.tags    || []).join(', '),
        summary:     book.summary  || '',
        publisher:   book.publisher || '',
        language:    book.language  || '',
        series:      book.series    || '',
        seriesIndex: book.seriesIndex || '',
        seriesTotal: book.seriesTotal || '',
      }
      editError.value = ''
      editDialog.value = true
    }

    function closeEdit() {
      editDialog.value = false
      editBook.value   = null
      editError.value  = ''
    }

    async function saveEdits() {
      if (!editBook.value) return
      editSaving.value = true
      editError.value  = ''
      try {
        const splitTrim = s => s.split(',').map(x => x.trim()).filter(Boolean)
        const body = {
          title:       editForm.value.title,
          authors:     splitTrim(editForm.value.authorsStr),
          tags:        splitTrim(editForm.value.tagsStr),
          summary:     editForm.value.summary,
          publisher:   editForm.value.publisher,
          language:    editForm.value.language,
          series:      editForm.value.series,
          seriesIndex: editForm.value.seriesIndex,
          seriesTotal: editForm.value.seriesTotal,
        }
        const res = await fetch('/api/books/' + editBook.value.id, {
          method:  'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body:    JSON.stringify(body),
        })
        if (!res.ok) throw new Error(await res.text() || 'Échec de l\'enregistrement')
        const updated = await res.json()
        // Update books grid list in place
        const idx = books.value.findIndex(b => b.id === updated.id)
        if (idx !== -1) books.value[idx] = updated
        // Update current book page if open
        if (currentBook.value && currentBook.value.id === updated.id) {
          currentBook.value = updated
        }
        showToast('Métadonnées enregistrées !', 'success')
        closeEdit()
      } catch (e) {
        editError.value = e.message
      } finally {
        editSaving.value = false
      }
    }

    // ---- Delete book ----
    const deleting = ref(false)

    async function deleteBook(book) {
      if (!book) return
      if (!window.confirm(`Supprimer « ${book.title} » ? Cette action est irréversible.`)) return
      deleting.value = true
      try {
        const res = await fetch('/api/books/' + book.id, { method: 'DELETE' })
        if (!res.ok) throw new Error(await res.text() || 'Échec de la suppression')
        showToast('Livre supprimé', 'success')
        navigateTo('/')
      } catch (e) {
        showToast('Erreur : ' + e.message, 'error')
      } finally {
        deleting.value = false
      }
    }

    // ---- Update cover image ----
    const coverUploading = ref(false)

    async function onCoverFileChange(book, event) {
      const file = event.target.files[0]
      if (!file || !book) return
      coverUploading.value = true
      try {
        const form = new FormData()
        form.append('cover', file)
        const res = await fetch('/api/books/' + book.id + '/cover', { method: 'POST', body: form })
        if (!res.ok) throw new Error(await res.text() || 'Échec de l\'envoi')
        // Force browser to re-fetch the updated cover (cache-bust with timestamp).
        book.coverUrl = '/covers/' + book.id + '?t=' + Date.now()
        showToast('Couverture mise à jour', 'success')
      } catch (e) {
        showToast('Erreur : ' + e.message, 'error')
      } finally {
        coverUploading.value = false
        // Reset the input so the same file can be re-selected if needed.
        event.target.value = ''
      }
    }

    // ---- Refresh catalog ----
    const refreshing = ref(false)

    async function doRefresh() {
      refreshing.value = true
      try {
        const res = await fetch('/api/refresh', { method: 'POST' })
        if (!res.ok) throw new Error('HTTP ' + res.status)
        await loadBooks()
        showToast('Catalogue mis à jour', 'success')
      } catch (e) {
        showToast('Échec de la mise à jour : ' + e.message, 'error')
      } finally {
        refreshing.value = false
      }
    }

    // ---- Upload ----
    const uploadDialog  = ref(false)
    const uploadFile    = ref(null)
    const uploading     = ref(false)
    const uploadError   = ref('')
    const uploadSuccess = ref('')
    const dragging      = ref(false)

    function onFileSelect(e) {
      const f = e.target.files[0]
      if (f) { uploadFile.value = f; uploadError.value = ''; uploadSuccess.value = '' }
    }

    function onDrop(e) {
      dragging.value = false
      const f = e.dataTransfer.files[0]
      if (f) { uploadFile.value = f; uploadError.value = ''; uploadSuccess.value = '' }
    }

    async function doUpload() {
      if (!uploadFile.value) return
      uploading.value = true
      uploadError.value = ''
      uploadSuccess.value = ''
      try {
        const fd = new FormData()
        fd.append('file', uploadFile.value)
        const res = await fetch('/api/upload', { method: 'POST', body: fd })
        if (!res.ok) throw new Error(await res.text() || 'Échec du téléversement')
        const book = await res.json()
        uploadSuccess.value = book.Title || uploadFile.value.name
        uploadFile.value = null
        showToast('Livre téléversé avec succès !', 'success')
        page.value = 1
        await loadBooks()
      } catch (e) {
        uploadError.value = e.message
      } finally {
        uploading.value = false
      }
    }

    function closeUpload() {
      uploadDialog.value  = false
      uploadFile.value    = null
      uploadError.value   = ''
      uploadSuccess.value = ''
      dragging.value      = false
    }

    // ---- Toast ----
    const toast = ref({ show: false, message: '', type: 'success' })
    let toastTimer = null
    function showToast(message, type = 'success') {
      clearTimeout(toastTimer)
      toast.value = { show: true, message, type }
      toastTimer = setTimeout(() => { toast.value.show = false }, 3000)
    }

    function formatBytes(n) {
      if (n < 1024) return n + ' o'
      if (n < 1048576) return (n / 1024).toFixed(1) + ' Ko'
      return (n / 1048576).toFixed(1) + ' Mo'
    }

    onMounted(() => {
      window.addEventListener('hashchange', onHashChange)
      onHashChange()
    })

    return {
      isDark, toggleDark,
      books, total, loading, page, searchQuery, unreadOnly, sortOrder, totalPages, pageNumbers,
      loadBooks, onSearchInput, toggleUnreadFilter, onSortChange, goPage, coverGradient,
      currentView, currentBook, bookLoading, navigateTo,
      currentSeries, seriesBooks, seriesLoading,
      togglingRead, toggleRead,
      setRating,
      deleting, deleteBook,
      coverUploading, onCoverFileChange,
      editDialog, editForm, editSaving, editError, openEdit, closeEdit, saveEdits,
      uploadDialog, uploadFile, uploading, uploadError, uploadSuccess, dragging,
      onFileSelect, onDrop, doUpload, closeUpload,
      refreshing, doRefresh,
      toast, formatBytes,
    }
  }
}).mount('#app')
</script>
</body>
</html>
